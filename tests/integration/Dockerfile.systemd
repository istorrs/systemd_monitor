# Ubuntu with systemd for integration testing
# Validates that systemd_monitor with Jeepney works correctly
FROM ubuntu:22.04

# Prevent interactive prompts
ENV DEBIAN_FRONTEND=noninteractive

# Install systemd and Python
RUN apt-get update && apt-get install -y \
    systemd \
    systemd-sysv \
    python3 \
    python3-pip \
    dbus \
    curl \
    git \
    && rm -rf /var/lib/apt/lists/*

# Configure systemd to run in container
RUN cd /lib/systemd/system/sysinit.target.wants/ \
    && ls | grep -v systemd-tmpfiles-setup | xargs rm -f $1

RUN rm -f /lib/systemd/system/multi-user.target.wants/* \
    /etc/systemd/system/*.wants/* \
    /lib/systemd/system/local-fs.target.wants/* \
    /lib/systemd/system/sockets.target.wants/*udev* \
    /lib/systemd/system/sockets.target.wants/*initctl* \
    /lib/systemd/system/basic.target.wants/* \
    /lib/systemd/system/anaconda.target.wants/* \
    /lib/systemd/system/plymouth* \
    /lib/systemd/system/systemd-update-utmp*

# Copy source code
COPY . /app
WORKDIR /app

# Upgrade pip and setuptools (Ubuntu 22.04 ships with old versions)
RUN pip3 install --no-cache-dir --upgrade pip setuptools

# Install Python dependencies
RUN pip3 install --no-cache-dir jeepney prometheus-client requests

# Install the package (from current source)
RUN pip3 install .

# Copy test services
COPY tests/integration/test_services/*.service /tmp/

# Volume for systemd
VOLUME [ "/sys/fs/cgroup" ]

# Entry point script
COPY tests/integration/entrypoint_systemd.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

# Run systemd
CMD ["/entrypoint.sh"]
