# Ubuntu with systemd for integration testing
# Validates that systemd_monitor works with pure Python (no C compiler needed)
FROM ubuntu:22.04

# Prevent interactive prompts
ENV DEBIAN_FRONTEND=noninteractive

# Install systemd and Python - NO BUILD TOOLS
# This proves the package installs without gcc/g++
RUN apt-get update && apt-get install -y \
    systemd \
    systemd-sysv \
    python3 \
    python3-pip \
    dbus \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Explicitly verify NO build tools installed
RUN if command -v gcc >/dev/null 2>&1; then \
        echo "ERROR: gcc found! This test must run without build tools."; \
        exit 1; \
    fi && \
    if command -v g++ >/dev/null 2>&1; then \
        echo "ERROR: g++ found! This test must run without build tools."; \
        exit 1; \
    fi && \
    echo "âœ“ Verified: No C compiler available (proving pure Python works)"

# Configure systemd to run in container
RUN cd /lib/systemd/system/sysinit.target.wants/ \
    && ls | grep -v systemd-tmpfiles-setup | xargs rm -f $1

RUN rm -f /lib/systemd/system/multi-user.target.wants/* \
    /etc/systemd/system/*.wants/* \
    /lib/systemd/system/local-fs.target.wants/* \
    /lib/systemd/system/sockets.target.wants/*udev* \
    /lib/systemd/system/sockets.target.wants/*initctl* \
    /lib/systemd/system/basic.target.wants/* \
    /lib/systemd/system/anaconda.target.wants/* \
    /lib/systemd/system/plymouth* \
    /lib/systemd/system/systemd-update-utmp*

# Copy source code
COPY . /app
WORKDIR /app

# Install Python package and dependencies (PURE PYTHON - no compilation!)
RUN pip3 install --no-cache-dir jeepney prometheus-client requests

# Install the package (should work without gcc)
RUN pip3 install -e .

# Copy test services
COPY tests/integration/test_services/*.service /tmp/

# Volume for systemd
VOLUME [ "/sys/fs/cgroup" ]

# Entry point script
COPY tests/integration/entrypoint_systemd.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

# Run systemd
CMD ["/entrypoint.sh"]
