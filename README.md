# Systemd Monitor

`systemd_monitor.py` is a Python script designed to monitor the state of specified systemd services on a Linux system. It leverages D-Bus to listen for signals related to service changes (like `ActiveState`, `SubState`, `JobNew`, `JobRemoved`) and also periodically polls services to ensure state consistency. All monitored events are logged to a file, and the script can generate statistics on service crashes, restarts, starts, and stops.

## Features

*   **Real-time Monitoring**: Uses D-Bus signals for immediate notifications of service state changes.
*   **Periodic Polling**: Supplements signal-based monitoring with periodic polling for robustness.
*   **Configurable Logging**: Logs service events to a specified file (default: `systemd_monitor.log`).
*   **Statistics Generation**: Parses log files to provide a summary of service activities, including crashes, restarts, starts, and stops.
*   **Flexible Configuration**: Supports configuration via JSON files and command-line arguments.
*   **Specific Service Targeting**: Monitors a configurable set of services.
*   **Debug Mode**: Offers a `--debug` flag for verbose logging, useful for troubleshooting.
*   **Graceful Shutdown**: Handles `Ctrl+C` (SIGINT) to stop monitoring, generate final statistics, and exit cleanly.

## How it Works

The script operates in two main capacities:

1.  **`DBusMonitor`**:
    *   Connects to the system D-Bus.
    *   Subscribes to systemd manager signals (`UnitNew`, `JobNew`, `JobRemoved`).
    *   For each monitored service, it subscribes to `PropertiesChanged` signals to track changes in `ActiveState` and `SubState`.
    *   Periodically polls the state of registered units to catch any missed signals or ensure current state accuracy.
    *   Logs all relevant events with timestamps, service name, state, substate, and source (signal, poll, etc.).

2.  **`StatsAnalyzer`**:
    *   Parses the log file generated by `DBusMonitor`.
    *   Aggregates data to count occurrences of crashes, restarts, starts, and stops for each monitored service.
    *   Prints a formatted table of these statistics to the console.

The `SystemdMonitor` class orchestrates these two components, running the D-Bus monitoring in one thread and periodically generating statistics in another.

## Configuration

The systemd monitor supports flexible configuration through JSON files and command-line arguments. You can create a default configuration file using:

```bash
python -m systemd_monitor --create-config config.json
```

### Configuration Options

- `monitored_services`: List of services to monitor (default: see below)
- `log_file`: Path to log file (default: `systemd_monitor.log`)
- `poll_interval`: Polling interval in milliseconds (default: 100)
- `stats_interval`: Statistics generation interval in seconds (default: 60)
- `max_retries`: Maximum retry attempts for failed operations (default: 3)
- `debug`: Enable debug logging (default: false)

### Default Monitored Services

The script is configured to monitor the following services by default:

```
wirepas-gateway.service
wirepas-sink-ttys1.service
wirepas-sink-ttys2.service
edger.connecteddev.service
edger.endries.service
devmgmt.service
hwcheck.service
provisioning.service
Node-Configuration.service
setup_cell_connect.service
wps_button_monitor.service
mosquitto.service
```

## Prerequisites

*   Python 3.7+
*   `python-dbus` (or `python3-dbus`)
*   `python-gi` (or `python3-gi`, `gir1.2-glib-2.0`)

These can typically be installed via your system's package manager. For example, on a Debian-based system:
```bash
sudo apt-get update
sudo apt-get install python3 python3-dbus python3-gi
```

## Installation

### From Source

1. Clone the repository:
```bash
git clone https://github.com/yourusername/systemd_monitor.git
cd systemd_monitor
```

2. Install the package:
```bash
pip install -e .
```

### Development Installation

For development, install with additional tools:
```bash
pip install -e ".[dev]"
```

## Usage

### Basic Usage

1.  **Run with default configuration**:
    ```bash
    systemd-monitor
    ```

2.  **Run with debug logging**:
    ```bash
    systemd-monitor --debug
    ```

### Advanced Configuration

1.  **Use a custom configuration file**:
    ```bash
    systemd-monitor --config my_config.json
    ```

2.  **Override specific settings**:
    ```bash
    systemd-monitor --services nginx.service apache2.service --log-file custom.log --debug
    ```

3.  **Create a default configuration file**:
    ```bash
    systemd-monitor --create-config config.json
    ```

### Command Line Options

- `--debug`: Enable debug logging
- `--config FILE`: Path to configuration file
- `--log-file FILE`: Log file path
- `--services SERVICE [SERVICE ...]`: List of services to monitor
- `--poll-interval MS`: Polling interval in milliseconds
- `--stats-interval SEC`: Statistics generation interval in seconds
- `--create-config FILE`: Create a default configuration file

The script will start monitoring the services and logging events to the specified log file. Statistics will be printed to the console periodically and upon exiting the script.

To stop the monitor, press `Ctrl+C`. It will then perform a final statistics generation before exiting.

## Output

*   **Log File**: Contains detailed entries for each detected service event.
    Example log entry:
    ```
    2023-10-27 10:00:00,123 - INFO - Service: wirepas-gateway, State: active, SubState: running, Source: PropertiesChanged
    ```
*   **Console Output**: Periodically displays statistics for monitored services.
    Example statistics output:
    ```
    Statistics from systemd_monitor.log:
    Service                   Crashes    Restarts   Starts     Stops
    -----------------------------------------------------------------
    wirepas-gateway           0          0          5          4
    mosquitto                 1          1          2          1
    ...
    ```

## Development

### Running Tests

```bash
pytest
```

### Code Formatting

```bash
black systemd_monitor/
```

### Type Checking

```bash
mypy systemd_monitor/
```

### Linting

```bash
flake8 systemd_monitor/
```

### Pre-commit Hooks

Install pre-commit hooks for automatic code quality checks:

```bash
pre-commit install
```

## Signal Handling

The script includes signal handlers for `SIGINT` (Ctrl+C) to ensure a graceful shutdown. An early signal handler is also in place to catch `Ctrl+C` even during the import phase or initial setup.

## Contributing

1. Fork the repository
2. Create a feature branch
3. Make your changes
4. Add tests for new functionality
5. Ensure all tests pass
6. Submit a pull request

## License

This project is licensed under the MIT License - see the LICENSE file for details.
